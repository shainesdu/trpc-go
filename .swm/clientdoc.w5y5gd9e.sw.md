---
title: client.doc
---
# Introduction

This document will walk you through the implementation of the client-side logic for <SwmToken path="/client/attachment.go" pos="22:12:12" line-data="// Attachment stores the Attachment of tRPC requests/responses.">`tRPC`</SwmToken>, focusing on the design decisions and key components involved in handling RPC requests and responses.

We will cover:

1. How attachments are managed within <SwmToken path="/client/attachment.go" pos="22:12:12" line-data="// Attachment stores the Attachment of tRPC requests/responses.">`tRPC`</SwmToken> requests and responses.
2. The structure and functionality of the client interface for initiating <SwmToken path="/client/client.go" pos="36:14:14" line-data="// Client is the interface that initiates RPCs and sends request messages to a server.">`RPCs`</SwmToken>.
3. The process of invoking backend calls and handling options.
4. The configuration and registration of backend services.
5. The handling of streaming <SwmToken path="/client/client.go" pos="36:14:14" line-data="// Client is the interface that initiates RPCs and sends request messages to a server.">`RPCs`</SwmToken>.

# Managing attachments

<SwmSnippet path="/client/attachment.go" line="22">

---

Attachments are used to store additional data related to <SwmToken path="/client/attachment.go" pos="22:12:12" line-data="// Attachment stores the Attachment of tRPC requests/responses.">`tRPC`</SwmToken> requests and responses. The <SwmToken path="/client/attachment.go" pos="22:2:2" line-data="// Attachment stores the Attachment of tRPC requests/responses.">`Attachment`</SwmToken> struct encapsulates this functionality, providing a mechanism to initialize and retrieve attachments.

```
// Attachment stores the Attachment of tRPC requests/responses.
type Attachment struct {
	attachment attachment.Attachment
}

// NewAttachment returns a new Attachment whose response Attachment is a NoopAttachment.
func NewAttachment(request io.Reader) *Attachment {
	return &Attachment{attachment: attachment.Attachment{Request: request, Response: attachment.NoopAttachment{}}}
}
```

---

</SwmSnippet>

The <SwmToken path="/client/attachment.go" pos="27:2:2" line-data="// NewAttachment returns a new Attachment whose response Attachment is a NoopAttachment.">`NewAttachment`</SwmToken> function creates a new attachment with a default response attachment, ensuring that requests can carry additional data without affecting the response handling.

# Client interface structure

<SwmSnippet path="/client/client.go" line="36">

---

The client interface is designed to initiate <SwmToken path="/client/client.go" pos="36:14:14" line-data="// Client is the interface that initiates RPCs and sends request messages to a server.">`RPCs`</SwmToken> and send request messages to a server. It provides a <SwmToken path="/client/client.go" pos="43:6:8" line-data="// It&#39;s thread-safe.">`thread-safe`</SwmToken> default client and a method to create new clients using default transport settings.

```
// Client is the interface that initiates RPCs and sends request messages to a server.
type Client interface {
	// Invoke performs a unary RPC.
	Invoke(ctx context.Context, reqBody interface{}, rspBody interface{}, opt ...Option) error
}

// DefaultClient is the default global client.
// It's thread-safe.
var DefaultClient = New()
```

---

</SwmSnippet>

The <SwmToken path="/client/client.go" pos="38:3:3" line-data="	// Invoke performs a unary RPC.">`Invoke`</SwmToken> method within the client interface is crucial for performing unary <SwmToken path="/client/client.go" pos="36:14:14" line-data="// Client is the interface that initiates RPCs and sends request messages to a server.">`RPCs`</SwmToken>, allowing for custom request and response handling through options.

# Invoking backend calls

<SwmSnippet path="/client/client.go" line="55">

---

The <SwmToken path="/client/client.go" pos="55:2:2" line-data="// Invoke invokes a backend call by passing in custom request/response message">`Invoke`</SwmToken> method in the client implementation handles backend calls by processing options, updating messages, and executing filter chains. This method ensures that each RPC call is configured correctly and executed efficiently.

```
// Invoke invokes a backend call by passing in custom request/response message
// and running selector filter, codec, transport etc.
func (c *client) Invoke(ctx context.Context, reqBody interface{}, rspBody interface{}, opt ...Option) (err error) {
	// The generic message structure data of the current request is retrieved from the context,
	// and each backend call uses a new msg generated by the client stub code.
	ctx, msg := codec.EnsureMessage(ctx)

	span, end, ctx := rpcz.NewSpanContext(ctx, "client")
```

---

</SwmSnippet>

<SwmSnippet path="/client/client.go" line="101">

---

Options are retrieved and processed to update the message and set necessary attributes for the RPC call. This includes setting timeouts, metadata, and service names.

```
// getOptions returns Options needed by each RPC.
func (c *client) getOptions(msg codec.Msg, opt ...Option) (*Options, error) {
	opts := getOptionsByCalleeAndUserOptions(msg.CalleeServiceName(), opt...).clone()

	// Set service info options.
	opts.SelectOptions = append(opts.SelectOptions, c.getServiceInfoOptions(msg)...)

	// The given input options have the highest priority
	// and they will override the original ones.
	for _, o := range opt {
		o(opts)
	}
```

---

</SwmSnippet>

<SwmSnippet path="/client/client.go" line="95">

---

The filter chain is processed to apply any client-side filters before the actual backend call is made, ensuring that all necessary pre-processing is completed.

```
	// Start filter chain processing.
	filters := c.fixFilters(opts)
	span.SetAttribute(rpcz.TRPCAttributeFilterNames, opts.FilterNames)
	return filters.Filter(contextWithOptions(ctx, opts), reqBody, rspBody, callFunc)
}
```

---

</SwmSnippet>

# Backend service configuration

<SwmSnippet path="/client/config.go" line="33">

---

Backend services are configured using the <SwmToken path="/client/config.go" pos="33:2:2" line-data="// BackendConfig defines the configuration needed to call the backend service.">`BackendConfig`</SwmToken> struct, which defines various parameters such as service names, network settings, and filters. This configuration is essential for setting up the client to communicate with backend services correctly.

```
// BackendConfig defines the configuration needed to call the backend service.
// It's empty by default and can be replaced.
type BackendConfig struct {
	// Callee is the name of the backend service.
	// The config file uses it as the key to set the parameters.
	// Usually, it is the proto name of the callee service defined in proto stub file,
	// and it is the same as ServiceName below.
	Callee      string `yaml:"callee"`   // Name of the backend service.
	ServiceName string `yaml:"name"`     // Backend service name.
	EnvName     string `yaml:"env_name"` // Env name of the callee.
	SetName     string `yaml:"set_name"` // "Set" name of the callee.
```

---

</SwmSnippet>

<SwmSnippet path="/client/config.go" line="85">

---

The <SwmToken path="/client/config.go" pos="85:2:2" line-data="// genOptions generates options for each RPC from BackendConfig.">`genOptions`</SwmToken> method generates options for each RPC based on the backend configuration, ensuring that all necessary settings are applied before initiating a call.

```
// genOptions generates options for each RPC from BackendConfig.
func (cfg *BackendConfig) genOptions() (*Options, error) {
	opts := NewOptions()
	if err := cfg.setNamingOptions(opts); err != nil {
		return nil, err
	}

	if cfg.Timeout > 0 {
		opts.Timeout = time.Duration(cfg.Timeout) * time.Millisecond
	}
	if cfg.Serialization != nil {
		opts.SerializationType = *cfg.Serialization
	}
	if icodec.IsValidCompressType(cfg.Compression) && cfg.Compression != codec.CompressTypeNoop {
		opts.CompressType = cfg.Compression
	}
```

---

</SwmSnippet>

# Streaming <SwmToken path="/client/client.go" pos="36:14:14" line-data="// Client is the interface that initiates RPCs and sends request messages to a server.">`RPCs`</SwmToken>

<SwmSnippet path="/client/stream.go" line="26">

---

Streaming <SwmToken path="/client/stream.go" pos="26:16:16" line-data="// Stream is the interface that performs streaming RPCs.">`RPCs`</SwmToken> are handled by the <SwmToken path="/client/stream.go" pos="26:2:2" line-data="// Stream is the interface that performs streaming RPCs.">`Stream`</SwmToken> interface, which provides methods for sending and receiving stream messages. This interface supports concurrent operations, allowing for efficient streaming communication.

```
// Stream is the interface that performs streaming RPCs.
type Stream interface {
	// Send sends stream messages.
	Send(ctx context.Context, m interface{}) error
	// Recv receives stream messages.
	Recv(ctx context.Context) ([]byte, error)
	// Init initiates all stream related options.
	Init(ctx context.Context, opt ...Option) (*Options, error)
	// Invoke initiates the lower layer connection to build the stream.
	Invoke(ctx context.Context) error
	// Close closes the stream.
	Close(ctx context.Context) error
}
```

---

</SwmSnippet>

<SwmSnippet path="/client/stream.go" line="76">

---

The <SwmToken path="/client/stream.go" pos="28:3:3" line-data="	// Send sends stream messages.">`Send`</SwmToken> and <SwmToken path="/client/stream.go" pos="30:3:3" line-data="	// Recv receives stream messages.">`Recv`</SwmToken> methods manage the serialization, compression, and transport of stream messages, ensuring that data is transmitted and received correctly.

```
	msg := codec.Message(ctx)
	reqBodyBuf, err := serializeAndCompress(ctx, msg, m, s.opts)
	if err != nil {
		return err
	}
```

---

</SwmSnippet>

<SwmSnippet path="/client/stream.go" line="150">

---

The <SwmToken path="/client/stream.go" pos="32:3:3" line-data="	// Init initiates all stream related options.">`Init`</SwmToken> method sets up the stream with the necessary options and selects a backend node for communication, preparing the stream for invocation.

```
	// Get options.
	opts, err := s.getOptions(msg, opt...)
	if err != nil {
		return nil, err
	}
```

---

</SwmSnippet>

This document provides an overview of the client-side logic for <SwmToken path="/client/attachment.go" pos="22:12:12" line-data="// Attachment stores the Attachment of tRPC requests/responses.">`tRPC`</SwmToken>, highlighting the key components and design decisions involved in managing attachments, initiating <SwmToken path="/client/client.go" pos="36:14:14" line-data="// Client is the interface that initiates RPCs and sends request messages to a server.">`RPCs`</SwmToken>, configuring backend services, and handling streaming communication.

<SwmMeta version="3.0.0" repo-id="Z2l0aHViJTNBJTNBdHJwYy1nbyUzQSUzQXNoYWluZXNkdQ==" repo-name="trpc-go"><sup>Powered by [Swimm](https://app.swimm.io/)</sup></SwmMeta>
